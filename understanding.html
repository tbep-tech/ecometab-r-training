<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>understanding.utf8</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/spacelab.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>








<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-sm-12 col-md-4 col-lg-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-sm-12 col-md-8 col-lg-9">




<div class="navbar navbar-inverse  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">NERRS Ecosystem Metabolism R Training</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Lessons
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="rbasics.html">R Basics</a>
    </li>
    <li>
      <a href="detiding.html">Detiding</a>
    </li>
    <li>
      <a href="odum.html">The Odum method</a>
    </li>
    <li>
      <a href="understanding.html">Understanding metabolism</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="Data_and_Resources.html">
    <span class="fas fa-list"></span>
     
    Data and resources
  </a>
</li>
<li>
  <a href="https://github.com/tbep-tech/ecometab-r-training">
    <span class="fas fa-github"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">




</div>


<div id="understanding-metabolism" class="section level1">
<h1>Understanding metabolism</h1>
<p>Get the lesson R script: <a href="understanding.R">understanding.R</a></p>
<p>Get the lesson data: <a href="data/779980.zip">download zip</a></p>
<div id="lesson-outline" class="section level2">
<h2>Lesson Outline</h2>
<ul>
<li><a href="#goals-and-motivation">Goals and motivation</a></li>
<li><a href="#summarizing-and-plotting-metabolism-data">Summarizing and plotting metabolism data</a></li>
<li><a href="#comparing-metabolism-with-water-quality-data">Comparing metabolism with water quality data</a></li>
<li><a href="#comparing-metabolism-with-nutrient-data">Comparing metabolism with nutrient data</a></li>
</ul>
</div>
<div id="lesson-exercises" class="section level2">
<h2>Lesson Exercises</h2>
<ul>
<li><a href="#exercise-1">Exercise 1</a></li>
<li><a href="#exercise-2">Exercise 2</a></li>
<li><a href="#exercise-3">Exercise 3</a></li>
</ul>
</div>
<div id="goals-and-motivation" class="section level2">
<h2>Goals and Motivation</h2>
<p>This lesson will teach you how to begin evaluating estuary metabolism estimates using additional data available in SWMP. Our goals are to understand the tools that are available in R, and the tidyverse in particular, to combine and explore relationships among variables that could influence metabolism. These tools are the building blocks of more detailed analyses that will help you understand site-specific relationships or to develop more comprehensive comparisons between reserves.</p>
<p>By the end of this lesson, you should know how or find the resources to be able to do the following:</p>
<ul>
<li>Summarize metabolism data using dplyr</li>
<li>Make some basic plots of metabolism using ggplot2</li>
<li>Combine metabolism estimates with additional SWMP data using dplyr</li>
<li>Compare metabolism estimates with additional SWMP data using ggplot2</li>
</ul>
</div>
<div id="summarizing-and-plotting-metabolism-data" class="section level2">
<h2>Summarizing and plotting metabolism data</h2>
<p>The <a href="https://cran.r-project.org/web/packages/SWMPr/index.html">SWMPr</a> and <a href="https://github.com/fawda123/wtregdo">WtRegDO</a> packages provide a set of easy to use functions for working with SWMP data to estimate metabolism. Our goals so far have been to demonstrate how to use the pre-existing functions to evaluate metabolism in our example datasets.</p>
<p>What we have not covered is how to use the other tools available in R to create some more customized examples of data analyses. This is obviously a huge topic that we cannot adequately cover in 90 minutes. However, our goal today is to provide you with some general building blocks for developing some more specific analyses. We’ll be leveraging some of the other packages in the tidyverse to accomplish this goal.</p>
<p>We start with our detided dissolved oxygen data from Apalachicola. Check out the <a href="detiding.html">detiding</a> to review to see how we got these data. For sake of time, you can import this data file from the website:</p>
<pre class="r"><code>load(url(&#39;https://tbep-tech.github.io/ecometab-r-training/data/apadtd.RData&#39;))
head(apadtd)</code></pre>
<pre><code>##         DateTimeStamp Temp  Sal DO_obs ATemp   BP WSpd Tide metab_date
## 1 2017-01-01 00:00:00 15.9 22.1    9.0  15.7 1020  4.8 1.88 2016-12-31
## 2 2017-01-01 01:00:00 15.9 22.1    9.0  16.9 1019  5.3 1.90 2016-12-31
## 3 2017-01-01 02:00:00 15.9 22.2    9.0  18.3 1018  3.9 1.94 2016-12-31
## 4 2017-01-01 03:00:00 16.0 23.4    8.6  19.0 1018  4.6 2.00 2016-12-31
## 5 2017-01-01 04:00:00 16.0 23.5    8.5  19.5 1018  5.0 2.01 2016-12-31
## 6 2017-01-01 05:00:00 16.1 23.6    8.4  19.4 1018  4.2 2.01 2016-12-31
##   solar_period          solar_time  day_hrs  dec_time hour        Beta2
## 1       sunset 2016-12-31 22:51:56 10.27807 -365.0000    0 -0.661774387
## 2       sunset 2016-12-31 22:51:56 10.27807 -364.9583    1 -0.197013200
## 3       sunset 2016-12-31 22:51:56 10.27807 -364.9167    2  0.035692964
## 4       sunset 2016-12-31 22:51:56 10.27807 -364.8750    3 -0.002937492
## 5       sunset 2016-12-31 22:51:56 10.27807 -364.8333    4 -0.187566704
## 6       sunset 2016-12-31 22:51:56 10.27807 -364.7917    5 -0.406850558
##     DO_prd   DO_nrm
## 1 8.821057 8.953471
## 2 8.714655 8.760363
## 3 8.657867 8.653582
## 4 8.625646 8.635960
## 5 8.583420 8.655840
## 6 8.534384 8.677753</code></pre>
<p>For this exercise, we’ll assume the detided data is appropriate for estimating metabolism. Remember, in practice you’ll want to check out the data with <code>evalcor</code> and evaluate the metabolism results with <code>meteval</code>.</p>
<p>We estimate metabolism as follows, using the detided dissolved oxygen data:</p>
<pre class="r"><code>tz &lt;- attr(apadtd$DateTimeStamp, which = &#39;tzone&#39;)
lat &lt;- 29.6747
long &lt;- -85.0583

apaeco &lt;- WtRegDO::ecometab(apadtd, DO_var = &quot;DO_nrm&quot;, tz = tz, lat = lat, long = long)
head(apaeco)</code></pre>
<pre><code>##                  Date       Pg        Rt        NEM
## 2016-12-31 2016-12-31       NA        NA         NA
## 2017-01-01 2017-01-01 37.24182 -61.00250 -23.760676
## 2017-01-02 2017-01-02 25.11674 -54.98618 -29.869439
## 2017-01-03 2017-01-03 27.53471 -32.50418  -4.969470
## 2017-01-04 2017-01-04 33.89419 -28.49020   5.403988
## 2017-01-05 2017-01-05 27.90777 -15.80833  12.099438</code></pre>
<p>The WtRegDO package has a plotting function that lets you view the metabolism results. This function lets you view the daily estimates or as aggregated summaries of the daily results. For follow-up analysis, it will be useful to understand how to plot the data using more general plotting functions. This will allow you to conduct your own analyses outside of the “pre-packaged” summaries in WtRegDO.</p>
<p>For plotting, we can use the ggplot2 library. This comes with the tidyverse, so no need to install it separately, but you’ll of course need to load the library.</p>
<pre class="r"><code>library(ggplot2)</code></pre>
<p>With ggplot2, you begin a plot with the function <code>ggplot()</code>. This creates a coordinate system that you can add layers to. The first argument of <code>ggplot()</code> is the dataset to use in the graph. So <code>ggplot(data = apaeco)</code> creates an empty base graph.</p>
<pre class="r"><code>ggplot(data = apaeco)</code></pre>
<p>The next step is to “map” variables in your dataset to the plot visual properties or “aesthetics” (i.e., x variable, y variable, etc.). The <code>mapping</code> argument is defined with <code>aes()</code>, and the <code>x</code> and <code>y</code> arguments of <code>aes()</code> specify which variables to map to the x and y axes. The functoin looks for the mapped variable in the <code>data</code> argument, in this case, <code>apaeco</code>.</p>
<pre class="r"><code>ggplot(data = apaeco, aes(x = Date, y = Pg))</code></pre>
<p>Now we need to add a “geometry” or <code>geom</code> to the plot to add components for viewing. We can add one or more layers (aka <code>geoms</code>) to <code>ggplot()</code>. The function <code>geom_point()</code> adds a layer of points to your plot based on the variable mappings in the <code>aes</code> function.</p>
<pre class="r"><code>ggplot(data = apaeco, aes(x = Date, y = Pg)) + 
  geom_point()</code></pre>
<p><img src="understanding_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<p>We can also overlay a line using <code>geom_line()</code>.</p>
<pre class="r"><code>ggplot(data = apaeco, aes(x = Date, y = Pg)) + 
  geom_point() + 
  geom_line()</code></pre>
<p><img src="understanding_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
<p>Those are the basics of ggplot. This structure may seem weird at first, but it’s design is purposeful and easily extendable. Just remember these requirements:</p>
<ul>
<li>All ggplot plots start with the <code>ggplot</code> function</li>
<li>It will need three pieces of information: the <strong>data</strong>, how the data are <strong>mapped</strong> to the plot <strong>aesthetics</strong>, and a <strong>geom</strong> layer</li>
</ul>
<p>The daily data are a bit messy, so maybe we want to aggregate to averages before plotting to make the trends a little more apparent. We need to use a few functions from the lubridate and dplyr packages to do this. As before, these come with the tidyverse package.</p>
<p>The lubridate package provides a set of functions to quickly modify date and time objects in R. It provides many functions to convert R vectors to date objects (e.g., a character strings of dates imported from a csv) and many functions to extract components of date objects (e.g., month, day, etc.). The latter is extremely useful for analysis.</p>
<p>First we load the lubridate and dplyr packages. Then we use both to create a month column from our existing date column in the apaeco data set. The <code>mutate</code> function from dplyr adds a column to our dataset and the <code>month</code> function extracts the month from the existing date column.</p>
<pre class="r"><code>library(lubridate)
library(dplyr)

apasum &lt;- mutate(apaeco, mo = month(Date))
head(apasum)</code></pre>
<pre><code>##                  Date       Pg        Rt        NEM mo
## 2016-12-31 2016-12-31       NA        NA         NA 12
## 2017-01-01 2017-01-01 37.24182 -61.00250 -23.760676  1
## 2017-01-02 2017-01-02 25.11674 -54.98618 -29.869439  1
## 2017-01-03 2017-01-03 27.53471 -32.50418  -4.969470  1
## 2017-01-04 2017-01-04 33.89419 -28.49020   5.403988  1
## 2017-01-05 2017-01-05 27.90777 -15.80833  12.099438  1</code></pre>
<p>We can plot the monthly values as boxplots with ggplot using the <code>geom_boxplot</code> geometry.</p>
<pre class="r"><code>ggplot(apasum, aes(x = mo, y = Pg, group = mo)) + 
  geom_boxplot()</code></pre>
<p><img src="understanding_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<p>Or, if we want to summarize the raw data, we can use the dplyr <code>group_by()</code> and <code>summarise()</code> functions. Here we are grouping the data by month, then taking the average production values. Note the use of <code>na.rm = T</code> in the <code>mean</code> function.</p>
<pre class="r"><code>apasum &lt;- group_by(apasum, mo)
apasum &lt;- summarise(apasum, meanpg = mean(Pg, na.rm = T))</code></pre>
<p>Then we plot as before using <code>geom_point()</code> and <code>geom_line()</code>.</p>
<pre class="r"><code>ggplot(apasum, aes(x = mo, y = meanpg)) + 
  geom_point() +
  geom_line()</code></pre>
<p><img src="understanding_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
</div>
<div id="exercise-1" class="section level2">
<h2>Exercise 1</h2>
<p>Now repeat some of the above analyses using the Sapelo Island metabolism data.</p>
<ol style="list-style-type: decimal">
<li><p>Load the detided Sapelo Island data (<code>sapdtd</code>) using this code:</p>
<pre class="r"><code>load(url(&#39;https://tbep-tech.github.io/ecometab-r-training/data/sapdtd.RData&#39;))</code></pre></li>
<li><p>Estimate metabolism using the <code>ecometab</code> function from the WtRegDO package. Run <code>WtRegDO::ecometab</code> using <code>tz = 'America/Jamaica'</code>, <code>lat = 31.39</code>, and <code>long = -81.28</code>.</p></li>
<li><p>Create a month variable for <code>sapdtd</code> using the <code>mutate</code> and <code>month</code> functions.</p></li>
<li><p>Group the data by month and summarize the average production using <code>group_by</code> and <code>summarise</code>.</p></li>
<li><p>Plot the results with <code>ggplot</code> by mapping the month and mean production columns to the x, y aesthetics and then using <code>geom_point()</code> or <code>geom_line()</code></p></li>
</ol>
</div>
<div id="comparing-metabolism-with-water-quality-data" class="section level2">
<h2>Comparing metabolism with water quality data</h2>
<p>One of the values of SWMP data is that we get a lot of supporting information that we can use to describe water quality changes. For metabolism, we might expect that it tracks physical drivers like temperature or light energy, or perhaps nutrient inputs. We can combine the metabolism estimates with other sWMP parameters to evaluate these hypotheses.</p>
<p>We can load SWMP data as before using tools from SWMPr, in particular using the <code>import_local</code>, <code>qaqc</code>, and <code>comb</code> functions. We’ve already done this a few times for the dry bar station at Apalachicola (see the “data prep” section in the <a href="odum.html">metabolism</a> lesson). Our detided dataset from above includes some relevant water quality and weather data that we can evaluate.</p>
<p>For example, perhaps we want to compare water temperature to metabolism. Since our metabolism estimates are on the daily scale, we’ll also want to summarize our water quality data at this scale. We can use tools in the lubridate and dplyr packages to do this, just as above.</p>
<p>We can add a date column, group by day, then take average water temperature.</p>
<pre class="r"><code># add a date column
apasum &lt;- mutate(apadtd, Date = date(DateTimeStamp))

# group by date
apasum &lt;- group_by(apasum, Date)

# summmarise average water temperature
apasum &lt;- summarise(apasum, meantemp = mean(Temp, na.rm = T))</code></pre>
<p>The last thing to do is to join these summarized data with the metabolism results. For this, we can use a “join” function from dplyr. We tell the <code>inner_join</code> function to combine the datasets using the <code>Date</code> column that is included in both the summarized water quality data and metabolism results.</p>
<pre class="r"><code># join water quality with metabolism
apasum &lt;- inner_join(apasum, apaeco, by = &#39;Date&#39;)</code></pre>
<p>Now we’re ready to plot. We can make a quick scatterplot with ggplot by mapping the appropriate variables in our dataset to the x, y aesthetics. Temperature is our independent variable in this case, so we put it on the x-axis.</p>
<pre class="r"><code>p &lt;- ggplot(data = apasum, aes(x = meantemp, y = Pg)) + 
  geom_point()
p</code></pre>
<p><img src="understanding_files/figure-html/unnamed-chunk-15-1.png" width="480" /></p>
<p>Not much there, so maybe we can want to try exploring some other relationships.</p>
</div>
<div id="exercise-2" class="section level2">
<h2>Exercise 2</h2>
<p>Repeat the above examples using the Sapelo Island dataset.</p>
<ol style="list-style-type: decimal">
<li><p>First, estimate metabolism for the Sapelo Isalnd data. You should have this already from the first exercise. Here it is again:</p>
<pre class="r"><code>load(url(&#39;https://tbep-tech.github.io/ecometab-r-training/data/sapdtd.RData&#39;))
sapeco &lt;- WtRegDO::ecometab(sapdtd, DO_var = &#39;DO_nrm&#39;, lat = 31.39, long = -81.28, tz = &#39;America/Jamaica&#39;)</code></pre></li>
<li><p>From the detided Sapelo Island dataset, create a date column with the <code>mutate</code> and <code>date</code> functions.<br />
</p></li>
<li><p>Summarize mean daily water temperature using <code>group_by</code> and <code>summarise</code>.</p></li>
<li><p>Join the summarized data with the metabolism data using <code>inner_join</code> and <code>by = 'Date'</code>.</p></li>
<li><p>Make a scatterplot in ggplot by mapping the mean temperature and production summaries to the x, y aesthetics.</p></li>
</ol>
</div>
<div id="comparing-metabolism-with-nutrient-data" class="section level2">
<h2>Comparing metabolism with nutrient data</h2>
<p>Our last example showed that we couldn’t find a very strong relationship of water temperature with production. That’s okay. We had a hypothesis, checked hte data, and then made a general conclusion that temperature isn’t a strong driver of production at the Apalachicola dry bar site. This doesn’t mean temperature isn’t always important - the limited data we have and our analysis at the daily scale provides us with some clues, but there’s much more we can evaluate.</p>
<p>Now we have the tools to start looking at some additional datasets. Another reasonable expectation is that metabolism may be driven by nutrients. We can us the same tools above to import, combine, and evaluate relationships of metabolism with nutrients.</p>
<p>Let’s import nutrient data from the dry bar station using <code>import_local</code> from SWMPr.</p>
<pre class="r"><code>apadbnut &lt;- import_local(path = &#39;data&#39;, station_code = &#39;apadbnut&#39;)</code></pre>
<p>We can use the <code>qaqc</code> function as before to handle the QA/QC flags.</p>
<pre class="r"><code>apadbnut &lt;- qaqc(apadbnut, qaqc_keep = c(&#39;0&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39;))
head(apadbnut)</code></pre>
<pre><code>##         datetimestamp  po4f  nh4f no2f no3f no23f chla_n
## 1 2017-01-04 11:31:00    NA 0.008   NA   NA    NA    9.6
## 2 2017-02-06 11:20:00    NA 0.024   NA   NA 0.140    8.8
## 3 2017-02-28 13:15:00    NA 0.016   NA   NA 0.270   11.0
## 4 2017-04-11 09:12:00 0.005 0.005   NA   NA 0.045   18.0
## 5 2017-05-02 10:29:00    NA 0.003   NA   NA 0.033   11.0
## 6 2017-06-08 12:20:00    NA 0.022   NA   NA 0.089   10.0</code></pre>
<p>If we want to compare any of the nutrient data to metabolism, we need to aggregate the information at a time scale that allows comparison. The metabolism results are daily, but the nutrient data are collected monthly.</p>
<p>We can first try joining the nutrient data to metabolism by day. First we need to create a date column for the nutrients.</p>
<pre class="r"><code>apadbnut &lt;- mutate(apadbnut, Date = date(datetimestamp))</code></pre>
<p>Now we can join by date. We use <code>inner_join</code> to combine by dates that are shared between the two datasets.</p>
<pre class="r"><code>apajoin &lt;- inner_join(apaeco, apadbnut, by = &#39;Date&#39;)</code></pre>
<p>We can now plot the metabolism estimates against the various nutrient observations. Here’s an example looking at chlorophyll.</p>
<pre class="r"><code>ggplot(apajoin, aes(x = chla_n, y = Pg)) + 
  geom_point()</code></pre>
<p><img src="understanding_files/figure-html/unnamed-chunk-21-1.png" width="480" /></p>
<p>Again, not super interesting. As a final attempt at comparing these data, we can try averaging results to a common unit of time, such as month. This may reduce some of the variability in the data and also provide a more general comparison by evaluating average conditions as opposed to “instantaneous” comparisons at the daily scale.</p>
<p>For both the metabolism and nutrient data, we can “floor” the dates to the first of each month, group by date, then summarize average values. Although technically we’re changing the dates, we are retaining the date class in the date column which can sometimes help with plotting or other downstream analysis. We use the <code>floor_date</code> function from lubridate.</p>
<pre class="r"><code># floor nutrient dates
apadbnut &lt;- mutate(apadbnut,
    dateflr = floor_date(Date, unit = &#39;month&#39;)
  )

# floor metabolism dates
apaeco &lt;- mutate(apaeco, 
    dateflr = floor_date(Date, unit = &#39;month&#39;)
  )</code></pre>
<p>Then group by the floored dates, summarize to averages, and join the data.</p>
<pre class="r"><code># group by and summarize apadbnut
apadbnut &lt;- group_by(apadbnut, dateflr)
apadbnut &lt;- summarise(apadbnut, 
  chla_n = mean(chla_n, na.rm = T), 
  nh4f = mean(nh4f, na.rm = T)
  )

# group by and summarize metabolism
apaeco &lt;- group_by(apaeco, dateflr)
apaeco &lt;- summarise(apaeco, 
  Pg = mean(Pg, na.rm = T), 
  Rt = mean(Rt, na.rm = T), 
  NEM = mean(NEM, na.rm = T)
  )

# join
apajoin &lt;- inner_join(apaeco, apadbnut, by = &#39;dateflr&#39;)</code></pre>
<p>Now plot as before. Here we’re looking at average Production vs chlorophyll using the monthly summaries.</p>
<pre class="r"><code>ggplot(apajoin, aes(x = chla_n, y = Pg)) + 
  geom_point()</code></pre>
<p><img src="understanding_files/figure-html/unnamed-chunk-24-1.png" width="480" /></p>
</div>
<div id="exercise-3" class="section level2">
<h2>Exercise 3</h2>
<p>Repeat the above examples using the Sapelo Island dataset.</p>
<ol style="list-style-type: decimal">
<li>Import the nutrient data for the <code>sapdcnut</code> station using <code>import_local</code> and <code>qaqc</code>.</li>
<li>Add a date column to the nutrients data using <code>mutate</code> from dplyr and <code>date</code> from lubridate.</li>
<li>Floor the date columns in the nutrients data and metabolism data (<code>sapeco</code> from exercise 2) using<code>unit = 'month'</code> with <code>floor_date</code> from lubridate.</li>
<li>Group and summarize the nutrients and metabolism data by the floor dates using <code>group_by</code> and <code>summarise</code>. For the summaries, take the average of the metabolism estimates and any of the nutrient parameters of your choosing.</li>
<li>Combine the summarized datasets Use <code>inner_join()</code> to combine the datasets by the floored date column.</li>
<li>Make a scatterplot in ggplot by mapping the mean nutrients and mean metabolism summaries to the x, y aesthetics.</li>
</ol>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
